---

- name: 'Validate config'
  cartridge_validate_config:
    hosts: '{{ play_hosts }}'
    hostvars: '{{ hostvars }}'
  run_once: true
  delegate_to: localhost
  become: false

- name: 'Validate OS Family'
  fail:
    msg: 'Deploy to {{ ansible_os_family }} distributions is not supported yet'
  when:
    - ansible_os_family is defined
    - ansible_os_family not in ["RedHat", "Debian"]

- name: "Set 'remote_user' for delegated tasks"
  set_fact:
    remote_user: '{{ ansible_user }}'
  when:
    - remote_user is not defined
    - ansible_user is defined

- name: 'Collect instance info'
  cartridge_set_instance_info:
    app_name: '{{ cartridge_app_name }}'
    instance_name: '{{ inventory_hostname }}'
    instance_vars:
      cartridge_package_path: '{{ cartridge_package_path }}'
      cartridge_app_install_dir: '{{ cartridge_app_install_dir }}'
      cartridge_app_instances_dir: '{{ cartridge_app_instances_dir }}'
      cartridge_conf_dir: '{{ cartridge_conf_dir }}'
      cartridge_run_dir: '{{ cartridge_run_dir }}'
      cartridge_data_dir: '{{ cartridge_data_dir }}'
      cartridge_tmpfiles_dir: '{{ cartridge_tmpfiles_dir }}'
      cartridge_multiversion: '{{ cartridge_multiversion }}'
      stateboard: '{{ stateboard }}'

- name: 'Select one instance for each physical machine'
  cartridge_set_single_instances_for_each_machine:
    hostvars: '{{ hostvars }}'
    play_hosts: '{{ play_hosts }}'
  run_once: true
  delegate_to: localhost
  become: false

- name: 'Select one not expelled instance'
  cartridge_set_not_expelled_instance:
    hostvars: '{{ hostvars }}'
    play_hosts: '{{ play_hosts }}'
  run_once: true
  delegate_to: localhost
  become: false
