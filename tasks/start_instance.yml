---
- name: Place {{ instance.name }} config
  copy:
    content: >-
      {{
        { cartridge_app_name + "." + instance.name: instance | delete_by_key("name") }
        | to_nice_yaml
      }}
    dest: '{{ cartridge_confdir }}/{{ cartridge_app_name }}.{{ instance.name }}.yml'
    owner: tarantool
    group: tarantool
    mode: '644'
  register: instance_config

- name: 'Start systemd service {{ cartridge_app_name }}@{{ instance.name }}'  # noqa 503
  systemd:
    name: '{{ cartridge_app_name }}@{{ instance.name }}'
    state: restarted
    enabled: true
  when: |
    package_updated
    or instance_config.changed
    or default_config.changed
