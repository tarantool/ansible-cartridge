---
- name: Check if it's possible to bootstrap vshard
  uri:
    url: "http://{{ control_instance_address }}:{{ control_instance_port  }}/admin/api"
    method: POST
    body_format: json
    status_code: 200
    return_content: true
    body:
      query: |-
        query {
          cluster {
            can_bootstrap_vshard
          }
        }
  register: can_bootstrap_vshard
  retries: 3
  delay: 5
  until: |
    can_bootstrap_vshard.status == 200
    and 'json' in can_bootstrap_vshard
    and 'errors' not in can_bootstrap_vshard.json

- name: Bootstrap vshard
  uri:
    url: "http://{{ control_instance_address }}:{{ control_instance_port  }}/admin/api"
    method: POST
    body_format: json
    status_code: 200
    return_content: true
    body:
      query: |-
        mutation {
          bootstrap_vshard: bootstrap_vshard
        }
  register: bootstrap_vshard
  retries: 3
  delay: 5
  until: |
    bootstrap_vshard.status == 200
    and 'json' in bootstrap_vshard
    and 'errors' not in bootstrap_vshard.json
  when: can_bootstrap_vshard.json.data.cluster.can_bootstrap_vshard
  changed_when: bootstrap_vshard.json.data.bootstrap_vshard
